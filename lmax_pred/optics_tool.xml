<tool id="optics_1" name="OPTICS" version="0.1.0">
  <description>Opsin Phenotype Tool for Inference of Color Sensitivity</description>
  <command detect_errors="aggressive">
  python '$__tool_directory__/prediction_functions_galaxy.py' '$input' '$output' '$blast_report' -m '$model' -b '$blast_checkbox' -r '$ref_sequence' -f '$ref_seq_file'</command>
  
  <inputs>
    <param format="fasta" name="input" type="data" label="Source file"/>
    <param name="model" type="select" optional="False" label="Select model used for predictions:" default="Vertebrate Model"> 
        <options from_file="db_model_names.tsv">  
            <column name="value" index="1"/>
        </options>
    </param>
    
    <conditional name="ref_options">
      <param name="blast_checkbox" type="boolean" optional = "True"
          truevalue="yes" falsevalue="no" 
          checked="true" 
          label="Enable for BLASTp analysis against corresponding model dataset" 
          help="Enables or disables BLASTp analysis of query sequences against VPOD datasets"/> 
          
          <when value="no" ref="blast_checkbox">
            <param name="ref_sequence" type="hidden" value="null"/>
            <param name="ref_seq_file" type="hidden" value="null"/>
          </when>

          <when value="yes" ref = "blast_checkbox"> 
            <conditional name = 'custom_ref_seq'>
              <param name="ref_sequence" type="select" label="Select reference sequence">
                <option value="Bovine">Bovine</option>
                <option value="Squid">Squid</option>
                <option value="Custom">Custom</option>
              </param>
                <when value = "Custom">
                <param format="fasta" name="ref_seq_file" type="data" label="Source file for custom reference sequence. *SHOULD CONTAIN 1 SEQUENCE* - Otherwise first sequence in file will be used."/>
                </when>
                <when value = "Bovine" ref = "ref_sequence">
                  <param name="ref_seq_file" type="hidden" value="null"/>
                </when>
                <when value = "Squid" ref = "ref_sequence">
                  <param name="ref_seq_file" type="hidden" value="null"/>
                </when>
            </conditional>
          </when>
    </conditional>

  </inputs>
  <outputs>
    <data format="tsv" name="output" label ="OPTICS λmax prediction on ${input.name}"/>
    <data format="txt" name="blast_report" label ="OPTICS blastp analysis on ${input.name}"/>
  </outputs>

  <tests>
    <test>
      <param name="input" value="test_seq_file.fa"/>
      <param name="model" value="Whole Dataset Model"/>
      <output name="output" file="msp_pred.tsv"/>
    </test>
  </tests>

  <help>
    This tool predicts Opsin Phenotype (λmax) from an input file of opsin amino-acid sequences in FASTA format.     
    
    Output 1 = A *.tsv* file of predictions matched to corresponding sequence 'name' take from the FASTA identifier. 

    Output 2 (if enabled) = A *.txt* file of each query sequence BLASTed against the corresponding model dataset to find sequence with closest %identity and find highlight sites that differ.
    
    *WARNING - If your file is not in proper FASTA format, this tool will not work properly!*

    Example of properly formatted FASTA entry:

    &gt;NP_001014890.1_rhodopsin_Bos taurus  

    MNGTEGPNFYVPFSNKTGVVRSPFEAPQYYLAEPWQFSMLAAYMFLLIMLGFPINFLTLYVTVQHKKLRT
    PLNYILLNLAVADLFMVFGGFTTTLYTSLHGYFVFGPTGCNLEGFFATLGGEIALWSLVVLAIERYVVVC
    KPMSNFRFGENHAIMGVAFTWVMALACAAPPLVGWSRYIPEGMQCSCGIDYYTPHEETNNESFVIYMFVV
    HFIIPLIVIFFCYGQLVFTVKEAAAQQQESATTQKAEKEVTRMVIIMVIAFLICWLPYAGVAFYIFTHQG
    SDFGPIFMTIPAFFAKTSAVYNPVIYIMMNKQFRNCMVTTLCCGKNPLGDDEASTTVSKTETSQVAPA

    Here is a link to a bibliography of the publications used to build VPOD_1.0 (the database we made and used to train our ML models): https://tinyurl.com/nm7tt3k8

    Know of publications for training opsin ML models not included in the VPOD_1.0 database?

    If so, please send them to us through this form: https://tinyurl.com/29afaxyr

    For those interested in VPOD and how the pipeline for training ML models, visit our GitHub: https://github.com/VisualPhysiologyDB/visual-physiology-opsin-db
  </help>

</tool>